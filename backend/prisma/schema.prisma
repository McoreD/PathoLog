generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Sex {
  female
  male
  other
  unknown
}

enum ParsingStatus {
  pending
  completed
  needs_review
  failed
}

enum ExtractionConfidence {
  high
  medium
  low
}

enum MappingMethod {
  dictionary
  generated
  user_confirmed
}

enum MappingConfidence {
  high
  medium
  low
}

enum ResultType {
  numeric
  qualitative
  semi_quantitative
  micro_target
  panel_summary
  admin_event
}

enum SourceFileProvider {
  azure_blob
  s3
  local
}

enum StandardSystem {
  loinc
  custom
  unknown
}

enum DetectionStatus {
  detected
  not_detected
  equivocal
  unknown
}

enum FlagSeverity {
  normal
  borderline
  high
  low
  critical
  unknown
}

enum CommentScope {
  analyte
  panel
  global
}

enum AdministrativeEventType {
  test_not_performed
  specimen_comment
  rejection
  cancellation
}

enum AdministrativeStatus {
  not_performed
  rejected
  cancelled
  unknown
}

enum TaskType {
  missing_short_code
  low_confidence
  unit_mismatch
  range_context
  unknown
}

enum TaskStatus {
  open
  resolved
  dismissed
}

enum PanelInterpretationFlag {
  normal
  abnormal
  borderline
  unknown
}

enum ValidationStatus {
  validated
  not_fully_validated
  unknown
}

model User {
  id             String          @id @default(uuid())
  email          String          @unique
  fullName       String?
  googleSub      String?         @unique
  microsoftSub   String?         @unique
  createdAtUtc   DateTime        @default(now())
  updatedAtUtc   DateTime        @updatedAt
  familyAccounts FamilyAccount[] @relation("FamilyOwner")
  familyMembers  FamilyMember[]
  patients       Patient[]       @relation("PatientOwner")
  sourceFiles    SourceFile[]    @relation("FileUploader")
  mappingEntries MappingDictionary[]
  reviewTasks    ReviewTask[]    @relation("TaskResolver")
  confirmedResults Result[]      @relation("ResultMappingConfirmed")
  auditLogs      AuditLog[]
}

model FamilyAccount {
  id             String         @id @default(uuid())
  ownerUserId    String
  name           String
  createdAtUtc   DateTime       @default(now())
  updatedAtUtc   DateTime       @updatedAt
  owner          User           @relation("FamilyOwner", fields: [ownerUserId], references: [id])
  members        FamilyMember[]
  patients       Patient[]
  mappingEntries MappingDictionary[]
}

model FamilyMember {
  id             String   @id @default(uuid())
  familyAccountId String
  userId         String
  role           String
  createdAtUtc   DateTime @default(now())
  familyAccount  FamilyAccount @relation(fields: [familyAccountId], references: [id])
  user           User          @relation(fields: [userId], references: [id])
}

model Patient {
  id                  String    @id @default(uuid())
  familyAccountId     String?
  ownerUserId         String?
  externalPatientKey  String?
  fullName            String
  dob                 DateTime?
  sex                 Sex?
  addressText         String?
  phoneText           String?
  medicareNumberText  String?
  createdAtUtc        DateTime  @default(now())
  updatedAtUtc        DateTime  @updatedAt
  familyAccount       FamilyAccount? @relation(fields: [familyAccountId], references: [id])
  owner               User?     @relation("PatientOwner", fields: [ownerUserId], references: [id])
  reports             Report[]
  results             Result[]
  cumulativeSeries    CumulativeSeries[]
  administrativeEvent AdministrativeEvent[]
  reviewTasks         ReviewTask[]
}

model SourceFile {
  id                String    @id @default(uuid())
  storageProvider   SourceFileProvider
  storageBucket     String?
  storageKey        String
  originalFilename  String
  contentType       String
  sizeBytes         Int
  uploadedByUserId  String
  uploadedAtUtc     DateTime  @default(now())
  uploader          User      @relation("FileUploader", fields: [uploadedByUserId], references: [id])
  reports           Report[]
}

model Report {
  id                             String      @id @default(uuid())
  patientId                      String
  sourceFileId                   String
  sourcePdfHash                  String      @unique
  providerName                   String?
  providerTradingName            String?
  providerAbn                    String?
  providerPhone                  String?
  providerWebsite                String?
  accreditationNpaac             Boolean?
  accreditationIso15189          Boolean?
  accreditationNumber            String?
  apaNumber                      String?
  nataNumbers                    String?
  generatorSystem                String?
  instrumentReportLevel          String?
  referrerName                   String?
  referrerRef                    String?
  copyTo                         String?
  requestedDate                  DateTime?
  collectedDatetimeLocal         DateTime?
  receivedDatetimeLocal          DateTime?
  reportedDatetimeLocal          DateTime?
  documentCreatedDatetimeLocal   DateTime?
  timeZone                       String?
  reportType                     String?
  panelNameOriginal              String?
  specimenOriginal               String?
  clinicalNotes                  String?
  globalComments                 String?
  rawText                        String?
  rawTextExtractionMethod        String?
  parsedPayloadJson              Json?
  pageCount                      Int?
  parsingStatus                  ParsingStatus @default(pending)
  parsingVersion                 String        @default("0.0.1")
  extractionConfidenceOverall    ExtractionConfidence?
  createdAtUtc                   DateTime     @default(now())
  updatedAtUtc                   DateTime     @updatedAt
  patient                        Patient      @relation(fields: [patientId], references: [id])
  sourceFile                     SourceFile   @relation(fields: [sourceFileId], references: [id])
  subpanels                      Subpanel[]
  results                        Result[]
  cumulativeSeries               CumulativeSeries[]
  administrativeEvents           AdministrativeEvent[]
  reviewTasks                    ReviewTask[]
  comments                       Comment[]
  @@index([patientId, collectedDatetimeLocal])
}

model Subpanel {
  id                        String    @id @default(uuid())
  reportId                  String
  subpanelNameOriginal      String?
  specimenOriginal          String?
  testMethod                String?
  instrumentSubpanelLevel   String?
  validationStatus          ValidationStatus?
  subpanelReportedDatetime  DateTime?
  panelInterpretationText   String?
  panelInterpretationFlag   PanelInterpretationFlag?
  sourceAnchor              String?
  report                    Report    @relation(fields: [reportId], references: [id])
  results                   Result[]
}

model Result {
  id                           String    @id @default(uuid())
  reportId                     String
  subpanelId                   String?
  patientId                    String
  analyteNameOriginal          String
  analyteShortCode             String?
  analyteCodeStandardSystem    StandardSystem @default(unknown)
  analyteCodeStandardValue     String?
  analyteGroup                 String?
  mappingMethod                MappingMethod? @default(dictionary)
  mappingConfidence            MappingConfidence? @default(medium)
  mappingDictionaryId          String?
  resultType                   ResultType
  valueNumeric                 Float?
  valueText                    String?
  unitOriginal                 String?
  unitNormalised               String?
  censored                     Boolean   @default(false)
  censorOperator               String?   @default("none")
  flagAbnormal                 Boolean?
  flagSeverity                 FlagSeverity?
  refLow                       Float?
  refHigh                      Float?
  refText                      String?
  referenceRangeContext        String?
  collectionContext            String?
  specimen                     String?
  specimenContainer            String?
  preservative                 String?
  method                       String?
  organismName                 String?
  targetGroup                  String?
  targetTaxonRank              String?
  detectionStatus              DetectionStatus?
  morphologyComment            String?
  commentText                  String?
  commentScope                 CommentScope?
  calculationName              String?
  calculationApplicabilityRules String?
  calculationExcludedReason    String?
  collectedDatetimeLocal       DateTime?
  reportedDatetimeLocal        DateTime?
  labNumber                    String?
  sourceAnchor                 String?
  extractionConfidence         ExtractionConfidence?
  mappingConfirmedByUserId     String?
  mappingConfirmedAtUtc        DateTime?
  mappingConfirmedBy           User?     @relation("ResultMappingConfirmed", fields: [mappingConfirmedByUserId], references: [id])
  createdAtUtc                 DateTime  @default(now())
  updatedAtUtc                 DateTime  @updatedAt
  report                       Report    @relation(fields: [reportId], references: [id])
  subpanel                     Subpanel? @relation(fields: [subpanelId], references: [id])
  patient                      Patient   @relation(fields: [patientId], references: [id])
  mappingDictionary            MappingDictionary? @relation(fields: [mappingDictionaryId], references: [id])
  referenceRanges              ReferenceRange[]
}

model AuditLog {
  id           String   @id @default(uuid())
  entityType   String
  entityId     String
  action       String
  userId       String?
  payload      Json?
  createdAtUtc DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id])
  @@index([entityType, entityId])
}

model ReferenceRange {
  id                    String    @id @default(uuid())
  resultId              String
  refLow                Float?
  refHigh               Float?
  refText               String?
  referenceRangeContext String?
  collectionContext     String?
  createdAtUtc          DateTime  @default(now())
  result                Result    @relation(fields: [resultId], references: [id])
}

model Comment {
  id            String       @id @default(uuid())
  reportId      String
  scope         CommentScope
  text          String
  createdAtUtc  DateTime     @default(now())
  report        Report       @relation(fields: [reportId], references: [id])
}

model AdministrativeEvent {
  id                 String    @id @default(uuid())
  reportId           String
  patientId          String
  eventType          AdministrativeEventType
  testNameRequested  String?
  testStatus         AdministrativeStatus
  notPerformedReason String?
  specimenComment    String?
  sourceAnchor       String?
  createdAtUtc       DateTime  @default(now())
  report             Report    @relation(fields: [reportId], references: [id])
  patient            Patient   @relation(fields: [patientId], references: [id])
}

model MappingDictionary {
  id                         String          @id @default(uuid())
  familyAccountId            String
  analyteNamePattern         String
  analyteShortCode           String
  analyteCodeStandardSystem  StandardSystem  @default(custom)
  analyteCodeStandardValue   String?
  preferredUnitNormalised    String?
  enabled                    Boolean         @default(true)
  createdByUserId            String
  createdAtUtc               DateTime        @default(now())
  updatedAtUtc               DateTime        @updatedAt
  familyAccount              FamilyAccount   @relation(fields: [familyAccountId], references: [id])
  createdBy                  User            @relation(fields: [createdByUserId], references: [id])
  results                    Result[]
  cumulativeColumns          CumulativeColumn[]
  @@unique([familyAccountId, analyteNamePattern])
}

model CumulativeSeries {
  id                 String    @id @default(uuid())
  reportId           String
  patientId          String
  seriesName         String
  specimenOriginal   String?
  sourceAnchor       String?
  extractionConfidence ExtractionConfidence?
  createdAtUtc       DateTime  @default(now())
  report             Report    @relation(fields: [reportId], references: [id])
  patient            Patient   @relation(fields: [patientId], references: [id])
  columns            CumulativeColumn[]
  rows               CumulativeRow[]
}

model CumulativeColumn {
  id                        String          @id @default(uuid())
  cumulativeSeriesId        String
  analyteNameOriginal       String
  analyteShortCode          String?
  analyteCodeStandardSystem StandardSystem   @default(unknown)
  analyteCodeStandardValue  String?
  unitOriginal              String?
  unitNormalised            String?
  mappingMethod             MappingMethod?   @default(dictionary)
  mappingConfidence         MappingConfidence? @default(medium)
  resultType                String
  mappingDictionaryId       String?
  cumulativeSeries          CumulativeSeries @relation(fields: [cumulativeSeriesId], references: [id])
  mappingDictionary         MappingDictionary? @relation(fields: [mappingDictionaryId], references: [id])
}

model CumulativeRow {
  id                 String    @id @default(uuid())
  cumulativeSeriesId String
  collectionDate     DateTime
  labNumber          String?
  valuesJson         Json
  cumulativeSeries   CumulativeSeries @relation(fields: [cumulativeSeriesId], references: [id])
}

model ReviewTask {
  id             String      @id @default(uuid())
  reportId       String
  patientId      String
  taskType       TaskType
  status         TaskStatus  @default(open)
  payloadJson    Json
  resolvedByUserId String?
  resolvedAtUtc  DateTime?
  createdAtUtc   DateTime    @default(now())
  report         Report      @relation(fields: [reportId], references: [id])
  patient        Patient     @relation(fields: [patientId], references: [id])
  resolvedBy     User?       @relation("TaskResolver", fields: [resolvedByUserId], references: [id])
  @@index([status, createdAtUtc])
  @@index([patientId, taskType])
}
